---
title: "Assessment"
subtitle: "Investigating Trends in Continuous Glucose Monitor Presecriptions in Scotland"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show 
date: "2025-10-31"
---
# Introduction
## Topic of focus

How does the prescription of continuous glucose monitoring(CGM) devices vary over time and between regions in Scotland - looking specifically at how it varies based on different demographic data?

# Methods

```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r packages}
#importing required packages
library(tidyverse)
library(janitor)
library(gt)
library(here)
library(shiny) #adds drop down menu to change year on map
library(sf) #draw geographical map
```

```{r theme_plots}
#custom theme for plots
theme_custom <- theme(
text = element_text(size = 12),
panel.grid = element_blank(),
panel.grid.major.y = element_line(colour = "#e3e1e1",
linetype = 2),
plot.title.position = 'plot',
legend.position = 'top',
legend.title = element_blank())

theme_set(theme_minimal() + theme_custom)
```

```{r data_import, echo = FALSE}
#loading all healthboard names
hb_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names() %>% 
  select(hb, hb_name)

#importing health board population estimate data
population_data <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv") %>% 
  clean_names() %>% 
  filter(sex == "All", year >= 2017, hb != "S92000003") %>% # 
  select(year, hb, sex, all_ages) # keeping only needed columns

#reading csv for CGM that has been made
data_cgm <- read_csv(here("data", "data_filtered", "data_cgm.csv"))

#loading all prescription data from 10/2017 to 2025
# links <- read.csv(here("data", "file_links.csv")) %>%
#   select(link) %>%
#   pull()
# 
# raw_prescription_data <- links %>%
#   map(read_csv) %>%
#   list_rbind()

#importing health boards geographical boundaries 
hb_map <- st_read(here("data","SG_NHS_HealthBoards_2019","SG_NHS_HealthBoards_2019.shp")) %>% 
  clean_names() %>% 
  mutate(hb_name = paste("NHS", hb_name))

#SIMD data import
simd_data <- read.csv("https://www.opendata.nhs.scot/dataset/78d41fa9-1a62-4f7b-9edb-3e8522a93378/resource/acade396-8430-4b34-895a-b3e757fa346e/download/simd2020v2_22062020.csv") %>% 
  clean_names() %>% 
  rename(simd_decile = simd2020v2country_decile) %>% 
  select(data_zone, hb, simd_decile)

#importing data about gp practises
gp_practice_data <- read.csv("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/47557411-7eda-4278-9d6d-d26ed2ceab5a/download/practice_contact_details_20251001_o") %>% 
  clean_names() %>% 
  select(practice_code, gp_practice_name, hb, data_zone, practice_list_size)


```

```{r tidying_data}
#Combining health boards which changed codes boundary changes do not matter

data_cgm <- data_cgm %>% 
  mutate(hbt = recode(hbt, "S08000018" = "S08000029", "S08000021" = "S08000031", "S08000023" = "S08000032", "S08000027" = "S08000030"), 
         year = as.numeric(year(paid_date_month))) # done to allow joining with population dataset
```

# Results
## CGM presriptions over time by healthboard

```{r filtering_data}
#Adding health board names and population estimates to the CGM dataset and then calculating rate per 100k population
graph_per_100k <- data_cgm %>% 
  left_join(hb_names, join_by(hbt == hb)) %>% 
  left_join(population_data, join_by(hbt == hb, year == year)) %>% 
  group_by(paid_date_month, hb_name, all_ages) %>% 
  summarise(total = sum(paid_quantity),
            total_per_100k = (total/all_ages)*100000) %>% 
  filter(!is.na(hb_name))
```

```{r graph_hb_100k}
#creating graph of CGM prescription per 100k by health board overtime

graph_per_100k %>% 
  ggplot(aes(x = paid_date_month, y = total_per_100k)) +
  geom_line(na.rm = TRUE) +
  facet_wrap(~hb_name) +
  theme_bw() +
  labs(title = "CGM prescriptions overtime",
       subtitle = "By health board in Scotland",
       x = "Year",
       y = "CGM Prescriptions (per 100k)") +
  theme(strip.text = element_text(size = 7))

```

The graph depicts all health boards increasing prescriptions in CGMs steadily overtime from November 2017 to August 2025. But there are geographic differences in the rate and total number of prescription between healthboards. NHS Dumfries and Galloway, Shetland and Western Isles prescribing more per 100,000 population in 2025 than any other health boards, and NHS Ayrshire and Arran, Tayside and Orkney having lower rates. 

## Interactive map of CGM prescriptions/number of diabetes patients per heathboard in the years 2018 and 2023
```{r filtering_data_map}
cgm_map <- data_cgm %>% 
  left_join(hb_names, join_by(hbt == hb)) %>% 
  left_join(population_data, join_by(hbt == hb, year == year)) %>% 
  group_by(year, hb_name, all_ages)%>% 
  summarise(total = sum(paid_quantity),
            total_per_100k = (total/all_ages)*100000) %>% 
  filter(!is.na(hb_name)) %>% 
  left_join(hb_map, join_by(hb_name)) 
```

```{r making_map}
# cgm_map %>% 
#   filter(year == 2023 | year == 2018) %>% 
#   ggplot(aes(fill = total_per_100k, geometry = geometry)) +
#     geom_sf() +
#   scale_fill_continuous(labels = scales::label_comma()) +
#   scale_fill_distiller(palette = 3) +
#   theme_void() +
#   facet_wrap(~year)
```

## Table showing the proportion of people in each age group by board compared to number of CGM prescriptions
```{r - table}

```

## CGM prescriptions by GP practise SIMD
```{r graph_simd}
simd_graph_data <- data_cgm %>% 
  left_join(gp_practice_data, join_by(gp_practice == practice_code)) %>% 
  left_join(simd_data, join_by(data_zone, hb)) %>% 
  left_join(hb_names, join_by(hbt == hb)) %>% 
  left_join(population_data, join_by(hbt == hb, year == year)) %>%
  filter(!is.na(gp_practice_name)) %>% 
  group_by(simd_decile, paid_date_month) %>% 
  summarise(total_cgm = sum(paid_quantity),
            total_population_gp = sum(practice_list_size),
            total_per_100k = (total_cgm/total_population_gp)*100000)

simd_graph_data %>% 
  mutate(simd_decile = paste("Decile", simd_decile)) %>% 
  ggplot(aes(x = paid_date_month, y = total_per_100k)) +
  geom_line(na.rm = TRUE) +
  facet_wrap(~simd_decile, nrow = 5) +
  theme_bw() +
  labs(title = "CGM prescriptions overtime",
       subtitle = "By SIMD in Scotland",
       x = "Year",
       y = "CGM Prescriptions (per 100k)") +
  theme(strip.text = element_text(size = 7))
```

## Future Plans
I plan to investigate the data in more detail in regards to demographics. Looking into differences in prescription of CGMs between practices based on SIMD classification and age groups within area. I will also try and obtain public information on diabetes prevalence and try and come this to the data to see if areas with more CGM prescriptions have higher diabetes rates.

# Limitations

# Conclusions 

# References 
