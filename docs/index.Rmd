---
title: "Assessment"
subtitle: "Investigating Trends in Continuous Glucose Monitor Presecriptions in Scotland"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show 
date: "2025-10-31"
---
# Introduction


# Methods

```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r packages, results=FALSE}
#importing required packages
library(tidyverse)
library(janitor)
library(gt)
library(here)
library(sf) #draw geographical map
library(ggiraph) #interactive maps
```

```{r function-import-clean-names}
#creating function to import data then clean names
import_clean_names <- function(file_path){
  read_csv(file_path)%>% 
    clean_names()}
```

```{r import-hb-names}
#loading all health board names
hb_names <- import_clean_names("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% select(hb, hb_name)
```

```{r hb-population-estimates}
#importing health board population estimate data
population_data_raw <- import_clean_names("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv")
```

```{r}
#tidying health board population data and splitting ages into distinct groups
population_data <- population_data_raw %>% 
  filter(sex == "All", year >= 2017, hb != "S92000003") %>% #removing uneeded data
  mutate(age_under_16 = rowSums(.[,7:22]), # splitting ages into groups
         age_16_to_24 = rowSums(.[,23:31]),
         age_25_to_34 = rowSums(.[,32:41]),
         age_35_to_54 = rowSums(.[,42:61]),
         age_55_to_64 = rowSums(.[,62:71]),
         age_65_plus = rowSums(.[,72:97])) %>%
  select(year, hb, sex, all_ages, age_under_16:age_65_plus) # keeping only needed columns

population_data_test <- population_data %>% 
  filter(year == 2024) %>% 
  mutate(year = 2025) %>%
  rbind(population_data)
```
# REMOVE

```{r cgm_data}
#reading csv for CGM that has been made
data_cgm <- read_csv(here("data", "data_filtered", "data_cgm.csv"))
```

```{r hb-boundaries, results = FALSE}
#importing health boards geographical boundaries 
hb_map <- st_read(here("data","SG_NHS_HealthBoards_2019","SG_NHS_HealthBoards_2019.shp")) %>% 
  clean_names() %>% 
  mutate(hb_name = paste("NHS", hb_name)) #chaning names to have NHS infront 
```


```{r simd-import}
#Importing SIMD data
simd_data <- import_clean_names("https://www.opendata.nhs.scot/dataset/78d41fa9-1a62-4f7b-9edb-3e8522a93378/resource/acade396-8430-4b34-895a-b3e757fa346e/download/simd2020v2_22062020.csv") %>% 
  rename(simd_decile = simd2020v2country_decile) %>% #changing name for easier coding
  select(data_zone, hb, simd_decile) #only keeping needed columns
```

```{r gp-practice-data}
#importing data about gp practice names, locations and populations
gp_practice_data <- import_clean_names("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/47557411-7eda-4278-9d6d-d26ed2ceab5a/download/practice_contact_details_20251001_o") %>% 
  select(practice_code:practice_list_size, hb, data_zone)#keeping only needed columns
```

```{r diabetes-healthboard-numbers, results = FALSE}
#importing data from file created for number of diabetic patients by health board
diabetes_by_healthboard <- import_clean_names(
  here("data","diabetes_rates_by_healthboard.csv"))
```

```{r import-all-prescription-data}
#Creating path for map function to import all health board data
  links <- read.csv(here("data", "file_links.csv")) %>%
  select(link) %>%
  pull()

#Loading all prescription data from 10/2017 to 2025 when CGMs were presribed
raw_prescription_data <- links %>%
  map(read_csv) %>% 
       # mutate(DMDCode = 0)) %>%
  list_rbind() %>%
  clean_names()

population_data %>% 
  ggplot(aes(x = year, y = all_ages)) +
  geom_line()+
  facet_wrap(~hb)
```

```{r tidying-CGM-data}
#Combining health boards which changed codes boundary changes do not matter
data_cgm <- raw_prescription_data %>% 
  filter(str_detect(bnf_item_code, "214800001")) %>%
  mutate(hbt = recode(hbt, "S08000018" = "S08000029", "S08000021" = "S08000031", "S08000023" = "S08000032", "S08000027" = "S08000030"), 
         year = as.numeric(year(paid_date_month)),#done to allow joining
         paid_date_month = parse_date_time(paid_date_month, "ym"),
         mutate(hbt = coalesce(hbt2014, hbt))) %>% 
  select(-c(hbt2014, prescribed_type, class_of_preparation_code))

data_cgm <- data_cgm %>% 
  mutate(hbt = recode(hbt, "S08000018" = "S08000029", "S08000021" = "S08000031", "S08000023" = "S08000032", "S08000027" = "S08000030"), 
         year = as.numeric(year(paid_date_month))) %>% 
  left_join(hb_names, join_by(hbt == hb))
```

# Results
```{r creating-function-summary}
summary_function <- function(data, grouping, filtering){data%>% 
    filter(!is.na({{filtering}})) %>%
    group_by(across(grouping)) %>% 
    summarise(total_cgm = sum(paid_quantity)) %>%
    left_join(population_data, join_by(hbt == hb, year == year)) %>% 
    mutate(total_per_100k = (total_cgm/all_ages)*100000)}
```

## CGM presriptions over time by healthboard

```{r filtering-data-graph-hb-100k}
#Adding health board names and population estimates to the CGM dataset and then calculating rate per 100k population
graph_per_100k <- summary_function(data = data_cgm, grouping = c("paid_date_month", "hb_name", "hbt", "year"), filtering = hb_name)

data_cgm %>% 
    filter(!is.na(hb_name)) %>%
    group_by(across(grouping)) %>% 
    summarise(total_cgm = sum(paid_quantity)) %>%
    left_join(population_data, join_by(hbt == hb, year == year)) %>% 
    mutate(total_per_100k = (total_cgm/all_ages)*100000)
```

```{r graph-hb-100k}
#creating graph of CGM prescription per 100k by health board overtime
graph_per_100k %>% 
  ggplot(aes(x = paid_date_month, y = total_per_100k)) +
  geom_line() +
  facet_wrap(~hb_name) +
  theme_bw() +
  labs(title = "CGM prescriptions overtime",
       subtitle = "By health board in Scotland",
       x = "Year",
       y = "CGM Prescriptions (per 100k)") +
  theme(strip.text = element_text(size = 7))
```

The graph depicts all health boards increasing prescriptions in CGMs steadily overtime from November 2017 to August 2025. But there are geographic differences in the rate and total number of prescription between healthboards. NHS Dumfries and Galloway, Shetland and Western Isles prescribing more per 100,000 population in 2025 than any other health boards, and NHS Ayrshire and Arran, Tayside and Orkney having lower rates. 

## Interactive map of CGM prescriptions/number of diabetes patients per heathboard in the years 2018 and 2023
```{r filtering-data-map}
#Filtering data for CGM map by joining with needed databases and calculating totals
cgm_map_data <- summary_function(data = data_cgm, grouping = c("hb_name","year","hbt"), filtering = hb_name) %>%
  filter(year == 2023 | year == 2018) %>% 
  left_join(diabetes_by_healthboard, join_by(hb_name, year == year)) %>% 
  mutate(cgm_per_diabetic_patient = (total_cgm/number_diabetic_patients)) 
  left_join(hb_map, join_by(hb_name)) 

cgm_map_data_2018_and_2023 <- cgm_map_data %>% 
  select(hb_name, year,cgm_per_diabetic_patient) %>% 
  pivot_wider(names_from = year, values_from = cgm_per_diabetic_patient, names_prefix = "cgm_per_diabetic_patient_") %>% 
  mutate(tooltip_text = paste(hb_name,"\n", "CGM prescriptions per diabetic patient 2018:", round(cgm_per_diabetic_patient_2018, 2),"\n", "CGM prescriptions per diabetic patient 2023:", round(cgm_per_diabetic_patient_2023, 2))) %>% 
  right_join(cgm_map_data, join_by(hb_name)) %>% 
  left_join(hb_map, join_by(hb_name)) 
```

```{r making-map}
#Making and styling map
cgm_map <- cgm_map_data_2018_and_2023 %>%
  ggplot(aes(fill = cgm_per_diabetic_patient, geometry = geometry)) +
  geom_sf_interactive(
    aes(data_id = hb_name, 
        tooltip = tooltip_text)) +
  scale_fill_distiller(palette = 3) +
  theme_void() +
  facet_grid(~year) +
  labs(title = "Interactive map showing all Scottish health boards",
       subtitle = "Coloured by number of CGMs prescribed per diabetic patient",
       fill = "Number of CGMs prescribed\nper diabetic patient")

girafe(ggobj = cgm_map)
```

## Table showing the proportion of people in each age group by board compared to number of CGM prescriptions in 2024

```{r table-filtering}
#Filtering data for table
age_table_data <- summary_function(data = data_cgm, grouping = c("hb_name","year","hbt")) %>% 
  mutate(across(age_under_16:age_65_plus, ~.x/all_ages))

```

```{r table-creation}
#Creating and styling table
age_table_data %>% 
  filter(year == 2024) %>% 
  ungroup() %>% 
  select(hb_name, year, age_under_16:total_per_100k) %>% 
  gt() %>% 
  fmt_percent(columns = age_under_16:age_65_plus, decimals = 2)
```

## CGM prescriptions by GP practise SIMD
```{r filtering-data-graph-cgm-by-simd}
#Combining GP data with SIMD and finding total number of patients per GP by SIMD
gp_population_by_simd <- gp_practice_data %>% 
  left_join(simd_data, join_by(data_zone)) %>% 
  group_by(simd_decile) %>% 
  summarise(total_gp_population = sum(practice_list_size))

#Combing patients per SIMD into CGM data and changing for graph
simd_graph_data <- data_cgm %>% 
  left_join(gp_practice_data, join_by(gp_practice == practice_code)) %>% 
  left_join(simd_data, join_by(data_zone, hb)) %>% 
  left_join(hb_names, join_by(hbt == hb)) %>% # remove
  filter(!is.na(gp_practice_name)) %>% 
  group_by(simd_decile, paid_date_month) %>% 
  summarise(total_cgm = sum(paid_quantity)) %>% 
  left_join(gp_population_by_simd, join_by(simd_decile)) %>% 
  mutate(total_per_100k = (total_cgm/total_gp_population)*100000)

simd_graph_data <- data_cgm %>%
  left_join(gp_practice_data, join_by(gp_practice == practice_code)) %>%
  left_join(simd_data, join_by(data_zone, hb)) %>%
  summary_function(data = ., grouping = c("simd_decile", "paid_date_month", "hbt", "year"), filtering = gp_practice_name) %>%
  left_join(gp_population_by_simd, join_by(simd_decile)) %>%
  mutate(total_per_100k = (total_cgm/total_gp_population)*100000)

```

```{r graph-creation-simd}
#Creating and styling graph
simd_graph_data %>% 
  mutate(simd_decile = factor(paste("Decile", simd_decile), levels = paste("Decile", 1:10))) %>% 
  ggplot(aes(x = paid_date_month, y = total_per_100k)) +
  geom_line() +
  facet_wrap(~simd_decile) +
  theme_bw() +
  labs(title = "CGM prescriptions overtime",
       subtitle = "By SIMD in Scotland",
       x = "Year",
       y = "CGM Prescriptions (per 100k)")

```


# Limitations

# Conclusions 

# References 
