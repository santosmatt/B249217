---
title: "Assessment"
subtitle: "Investigating Trends Continous Glucose Monitor Presecriptions in Scotland"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show 
date: "2025-10-31"
runtime: shiny
---
# Introduction
## Topic of focus

How does the prescription of continuous glucose monitoring(CGM) devices vary over time and between regions in Scotland - looking specifically at how it varies based on different demographic data?

# Methods

# Results
## Graph
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = TRUE, warning=FALSE, message=FALSE}
#importing required packages
library(tidyverse)
library(janitor)
library(gt)
library(here)
library(shiny)
```

```{r}
#custom theme for plots
theme_custom <- theme(
text = element_text(size = 12),
panel.grid = element_blank(),
panel.grid.major.y = element_line(colour = "#e3e1e1",
linetype = 2),
plot.title.position = 'plot',
legend.position = 'top',
legend.title = element_blank())

theme_set(theme_minimal() + theme_custom)


```


```{r, message = FALSE, warning = FALSE}
#loading all healthboard names
hb_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names() %>% 
  select(hb, hb_name)

#loading population data by health board

population_data <- read_csv(here( "data", "data_filtered", "UV102a_age_health_board_census.csv"), skip = 10) %>% 
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  filter(Age == "All people" & Sex == "All people") %>% 
  select(hb_name, hb_population) %>% 
  mutate(hb_name = paste("NHS", hb_name))

#reading csv for CGM that has been made
data_cgm <- read_csv(file = here("data", "data_filtered", "data_cgm.csv"))
```



```{r, message = FALSE}
#Combining health boards which changed codes boundary changes do not matter

data_cgm <- data_cgm %>% 
  mutate(hbt = recode(hbt, "S08000018" = "S08000029", "S08000021" = "S08000031", "S08000023" = "S08000032", "S08000027" = "S08000030"))
```

```{r, message=FALSE}
#Adding health board names and population estimates to the CGM dataset and then calculating rate per 100k population
graph_per_100k <- data_cgm %>% 
  left_join(hb_names, join_by(hbt == hb)) %>% 
  left_join(population_data, join_by(hb_name)) %>% 
  group_by(paid_date_month, hb_name, hb_population) %>% 
  summarise(total = sum(paid_quantity),
            total_per_100k = unique((total/hb_population)*100000)) %>% 
  filter(!is.na(hb_name))
```


```{r warning = FALSE}
#creating graph of CGM prescription per 100k by health board overtime

graph_per_100k %>% 
  ggplot(aes(x = paid_date_month, y = total_per_100k)) +
  geom_line(na.rm = TRUE) +
  facet_wrap(~hb_name) +
  theme_bw() +
  labs(title = "CGM prescriptions overtime",
       subtitle = "By health board in Scotland",
       x = "Year",
       y = "CGM Prescriptions (per 100k)") +
  theme(strip.text = element_text(size = 7))

```

The graph depicts all health boards increasing prescriptions in CGMs steadily overtime from November 2017 to August 2025. But there are geographic differences in the rate and total number of prescription between healthboards. NHS Dumfries and Galloway, Shetland and Western Isles prescribing more per 100,000 population in 2025 than any other health boards, and NHS Ayrshire and Arran, Tayside and Orkney having lower rates. 

```{r}
selectInput("n_breaks", label = "Health Board",
              choices = hb_names$hb_name, selected = "NHS Borders")

```

### ...that build a histogram.

```{r echo = FALSE}
renderPlot({
  graph_per_100k %>% 
    filter(hb_name == as.character(input$n_breaks)) %>% 
      ggplot(aes(x = paid_date_month, y = total_per_100k)) +
      geom_line(na.rm = TRUE) +
      theme_bw() +
      facet_wrap(~hb_name) +
      labs(title = "CGM prescriptions overtime",
           subtitle = "By health board in Scotland",
           x = "Year",
           y = "CGM Prescriptions (per 100k)") +
      theme(strip.text = element_text(size = 7))
})
```


## Future Plans
I plan to investigate the data in more detail in regards to demographics. Looking into differences in prescription of CGMs between practices based on SIMD classification and age groups within area. I will also try and obtain public information on diabetes prevalence and try and come this to the data to see if areas with more CGM prescriptions have higher diabetes rates.

# Limitations
# Conclusions 
# References 